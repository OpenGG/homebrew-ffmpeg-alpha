name: Auto-Sync & Build FFmpeg Alpha

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  build-and-publish:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      # ====================================================
      # 新增步骤：将当前仓库注册为本地 Tap
      # ====================================================
      - name: Register Local Tap
        run: |
          # 获取当前仓库的 owner 和 repo 名称
          # 例如: yourname/homebrew-ffmpeg-alpha
          TAP_DIR="$(brew --repo)/Library/Taps/${{ github.repository }}"
          
          # 创建父目录
          mkdir -p "$(dirname "$TAP_DIR")"
          
          # 创建软链接：把当前工作目录链接到 Homebrew 的 Taps 目录
          ln -sfn "$PWD" "$TAP_DIR"
          
          echo "✅ Local tap registered at $TAP_DIR"

      - name: Fetch Upstream Formulas
        run: |
          mkdir -p Formula
          brew update
          brew cat x265 > Formula/x265-alpha.rb
          brew cat ffmpeg > Formula/ffmpeg-alpha.rb

      - name: Apply Patches
        run: ruby scripts/patch_formulas.rb

      # ====================================================
      # 修正：现在不需要用文件路径了，直接用名字安装
      # ====================================================
      - name: Build x265-alpha
        run: brew install --build-from-source x265-alpha

      - name: Build FFmpeg Bottle
        run: |
          brew unlink x265 || true
          
          # 注意：这里直接用配方名称 ffmpeg-alpha，不要带 ./Formula/ 前缀
          brew install --build-bottle ffmpeg-alpha
          
          # 打包
          brew bottle ffmpeg-alpha --root-url="https://github.com/${{ github.repository }}/releases/download/auto-build"
          
          echo "BOTTLE_NAME=$(ls *.bottle.tar.gz)" >> $GITHUB_ENV

      - name: Push Updated Formula
        run: |
          # 更新配方文件 (同样使用名字)
          brew bottle --merge --write --no-commit ffmpeg-alpha
          
          git config user.name "Auto Builder"
          git config user.email "actions@github.com"
          git add Formula/*.rb
          git commit -m "Auto-update: Sync upstream and rebuild bottle" || echo "No changes"
          git push

      - name: Upload Binary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create auto-build ${{ env.BOTTLE_NAME }} \
            --title "Auto Build Artifacts" \
            --notes "Automated build from upstream" \
            --repo ${{ github.repository }} \
            --clobber
