name: Build Both x265 & FFmpeg

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  build-and-publish:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      # 必须注册本地 Tap，否则 install 会报错
      - name: Register Local Tap
        run: |
          TAP_DIR="$(brew --repo)/Library/Taps/${{ github.repository }}"
          mkdir -p "$(dirname "$TAP_DIR")"
          ln -sfn "$PWD" "$TAP_DIR"

      - name: Fetch Upstream Formulas
        run: |
          mkdir -p Formula
          brew update
          brew cat x265 > Formula/x265-alpha.rb
          brew cat ffmpeg > Formula/ffmpeg-alpha.rb

      - name: Apply Patches
        run: ruby scripts/patch_formulas.rb

      # ====================================================
      # 阶段 1: 编译并打包 x265-alpha
      # ====================================================
      - name: Build x265-alpha Bottle
        run: |
          # 编译 x265-alpha (生成动态库)
          brew install --build-bottle x265-alpha
          
          # 打包 (生成 .tar.gz 和 .json)
          brew bottle x265-alpha --root-url="https://github.com/${{ github.repository }}/releases/download/auto-build"

      # ====================================================
      # 阶段 2: 编译并打包 ffmpeg-alpha
      # ====================================================
      - name: Build FFmpeg-alpha Bottle
        run: |
          # 此时 x265-alpha 已经安装在系统里了
          # ffmpeg 编译时会自动 link 到它
          brew install --build-bottle ffmpeg-alpha
          
          # 打包
          brew bottle ffmpeg-alpha --root-url="https://github.com/${{ github.repository }}/releases/download/auto-build"

      # ====================================================
      # 阶段 3: 合并 SHA256 并发布
      # ====================================================
      - name: Push Updated Formulas
        run: |
          # --merge 会自动读取当前目录下的 .json 文件并修改 .rb 文件
          brew bottle --merge --write --no-commit x265-alpha
          brew bottle --merge --write --no-commit ffmpeg-alpha
          
          git config user.name "Auto Builder"
          git config user.email "actions@github.com"
          git add Formula/*.rb
          git commit -m "Auto-update: Publish new bottles for x265-alpha and ffmpeg-alpha" || echo "No changes"
          git push

      - name: Upload Artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 上传所有的 bottle 文件
          gh release create auto-build *.bottle.tar.gz \
            --title "Auto Build Artifacts" \
            --notes "Contains both x265-alpha and ffmpeg-alpha bottles" \
            --repo ${{ github.repository }} \
            --clobber
