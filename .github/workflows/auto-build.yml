name: Build Both x265 & FFmpeg

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  build-and-publish:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Register Local Tap
        run: |
          TAP_DIR="$(brew --repo)/Library/Taps/${{ github.repository }}"
          mkdir -p "$(dirname "$TAP_DIR")"
          ln -sfn "$PWD" "$TAP_DIR"

      - name: Fetch Upstream Formulas
        run: |
          mkdir -p Formula
          brew update
          brew cat x265 > Formula/x265-alpha.rb
          brew cat ffmpeg > Formula/ffmpeg-alpha.rb

      - name: Apply Patches
        run: ruby scripts/patch_formulas.rb

      # 阶段 1: 编译 x265
      - name: Build x265-alpha Bottle
        run: |
          brew install --build-bottle x265-alpha
          brew bottle x265-alpha --json --root-url="https://github.com/${{ github.repository }}/releases/download/auto-build"

      # 阶段 2: 编译 ffmpeg
      - name: Build FFmpeg-alpha Bottle
        run: |
          brew install --build-bottle ffmpeg-alpha
          brew bottle ffmpeg-alpha --json --root-url="https://github.com/${{ github.repository }}/releases/download/auto-build"

      # 阶段 3: 合并 Bottle 信息 (直接在当前目录修改)
      - name: Merge Bottle Info
        run: |
          echo "Merging bottle info into Formula files..."
          brew bottle --merge --write --no-commit *.json

      # 修复 Git 权限 (Token 注入)
      - name: Fix Git Auth
        run: |
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"

      # 阶段 4: 提交并推送
      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update: Publish new bottles"
          file_pattern: 'Formula/*.rb'
          branch: main
          push_options: '--force'
          skip_fetch: true

      # 阶段 5: 处理文件名兼容性并上传
      - name: Upload Artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # === 关键逻辑：原地复制一份单横线版本 ===
          # 为了解决 Homebrew 只能下载 name-version (单横线) 的 bug
          for f in *--*.tar.gz; do
            # 如果文件存在
            [ -e "$f" ] || continue
            # 复制为单横线版本: x265-alpha--4.1.tar.gz -> x265-alpha-4.1.tar.gz
            cp "$f" "${f/--/-}"
          done
          
          echo "Ready to upload:"
          ls -lh *bottle*.tar.gz

          # 清理旧 Release
          gh release delete auto-build --yes --cleanup-tag --repo ${{ github.repository }} || true

          # 上传所有 tar.gz (包含原来的和改名后的)
          # 使用 *bottle*.tar.gz 通配符，确保能匹配带 Rebuild 编号的文件
          gh release create auto-build *bottle*.tar.gz \
            --title "Auto Build Artifacts" \
            --notes "Contains both x265-alpha and ffmpeg-alpha bottles. Built at $(date)" \
            --repo ${{ github.repository }}