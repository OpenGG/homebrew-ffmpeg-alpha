name: Build & Debug (Forensics)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  build-and-debug:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Register Local Tap
        run: |
          TAP_DIR="$(brew --repo)/Library/Taps/${{ github.repository }}"
          mkdir -p "$(dirname "$TAP_DIR")"
          ln -sfn "$PWD" "$TAP_DIR"

      - name: Fetch Upstream Formulas
        run: |
          mkdir -p Formula
          brew update
          brew cat x265 > Formula/x265-alpha.rb
          brew cat ffmpeg > Formula/ffmpeg-alpha.rb

      - name: Apply Patches
        run: ruby scripts/patch_formulas.rb

      # é˜¶æ®µ 1: ç¼–è¯‘ x265
      - name: Build x265-alpha Bottle
        run: |
          brew install --build-bottle x265-alpha
          brew bottle x265-alpha --json --root-url="https://github.com/${{ github.repository }}/releases/download/auto-build"

      # é˜¶æ®µ 2: ç¼–è¯‘ ffmpeg
      - name: Build FFmpeg-alpha Bottle
        run: |
          brew install --build-bottle ffmpeg-alpha
          brew bottle ffmpeg-alpha --json --root-url="https://github.com/${{ github.repository }}/releases/download/auto-build"

      # é˜¶æ®µ 3: åˆå¹¶ Bottle ä¿¡æ¯
      - name: Merge Bottle Info
        run: |
          echo "Merging bottle info into Formula files..."
          brew bottle --merge --write --no-commit *.json

      # ========================================================
      # ğŸ•µï¸â€â™‚ï¸ å–è¯ç¯èŠ‚ 1ï¼šæäº¤ä»£ç å‰
      # ========================================================
      - name: ğŸ” [FORENSICS] Check Files BEFORE Git Action
        run: |
          echo "=========================================="
          echo "ğŸ“ Current Directory: $(pwd)"
          echo "=========================================="
          
          echo "ğŸ“‚ Execute: ls -lah"
          ls -lah
          
          echo "=========================================="
          echo "ğŸ” Execute: find . -iname '*.bottle.tar.gz'"
          find . -iname '*.bottle.tar.gz'
          echo "=========================================="

      # ä¿®å¤ Git æƒé™ (å¿…é¡»ä¿ç•™ï¼Œå¦åˆ™æ— æ³•è¿›è¡Œä¸‹ä¸€æ­¥æµ‹è¯•)
      - name: Fix Git Auth
        run: |
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"

      # é˜¶æ®µ 4: æ‰§è¡Œé‚£ä¸ªå«Œç–‘å¾ˆå¤§çš„ Git Action
      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update: Publish new bottles"
          file_pattern: 'Formula/*.rb'
          branch: main
          push_options: '--force'
          skip_fetch: true

      # ========================================================
      # ğŸ•µï¸â€â™‚ï¸ å–è¯ç¯èŠ‚ 2ï¼šæäº¤ä»£ç å
      # ========================================================
      - name: ğŸ” [FORENSICS] Check Files AFTER Git Action
        if: always() # å³ä½¿ä¸Šé¢æ­¥éª¤å¤±è´¥ä¹Ÿè¦è¿è¡Œ
        run: |
          echo "=========================================="
          echo "ğŸ“ Current Directory: $(pwd)"
          echo "=========================================="
          
          echo "ğŸ“‚ Execute: ls -lah"
          ls -lah
          
          echo "=========================================="
          echo "ğŸ” Execute: find . -iname '*.bottle.tar.gz'"
          find . -iname '*.bottle.tar.gz'
          echo "=========================================="

      # å°è¯•ä¸Šä¼  (å¦‚æœ find èƒ½æ‰¾åˆ°æ–‡ä»¶)
      - name: Upload Artifacts
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å°è¯•åˆ é™¤æ—§ Release
          gh release delete auto-build --yes --cleanup-tag --repo ${{ github.repository }} || true

          # ä½¿ç”¨ find å‘½ä»¤çš„ç»“æœä½œä¸ºä¸Šä¼ å‚æ•°ï¼Œé˜²æ­¢é€šé…ç¬¦æ‰©å±•å¤±è´¥
          BOTTLE_FILES=$(find . -iname '*.bottle.tar.gz')
          
          if [ -z "$BOTTLE_FILES" ]; then
            echo "âŒ Error: No bottle files found to upload!"
            exit 1
          else
            echo "âœ… Found files to upload: $BOTTLE_FILES"
            gh release create auto-build $BOTTLE_FILES \
              --title "Auto Build Artifacts" \
              --notes "Contains both x265-alpha and ffmpeg-alpha bottles. Built at $(date)" \
              --repo ${{ github.repository }}
          fi